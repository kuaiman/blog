title: 我遇到一个Bug，金额大于一千万就报错
date: 2016-01-13 13:43:13
tags:
---

这是一个在测试环境发现的一个BUG，感觉很有趣，便写出来分享一下。
我在银行做系统开发，“金额”基本上是最常见的字段，也是最不能出错的字段了。每一个错误都代表者实打实的资金损失，无论是客户的还是银行的。所以，作为开发人员，对这个字段也相对敏感一些。金额这个字段的规则也相对其他字段更复杂一些。举个例子来说，金额是一个数字，可以是这样12；当然也有小数点的情况，比如这样12.34；人们还有这样的习惯，每隔3位有一个逗号分隔符，比如这样1,000.23。可是一千万是个什么特殊情况，为什么会有问题呢？
<!--more-->
目前系统为了校验前端上送的数据，有一套统一的校验机制。大概过程就是，先使用jackson框架将前端上送的JSON数据进行解析，然后根据这个字段配置的正则表达式进行校验，校验不通过，就会报错。
这是一个工作日，在我们内部通讯工具上弹出来一个同事的窗口。“我们有一个交易上送金额，80099690.89元，校验就报错，但是809969.89元校验就不报错。”我见到这个问题后，第一反应是：“怎么可能，这个校验规则在生产环境运行了那么久都没有出错，怎么会突然有问题呢？会不会是哪里搞错了？”然后，这位同事又发来“前端上送的json报文中，金额使用的数字类型`amount:80099690.89`,但我们平时都上送的字符串类型`amount:'80,099,690.89'`”。于是，我开始怀疑那个正则表达式是否正确，还在埋怨是谁写的正则，居然要求必须有逗号分隔符的时候，我看到了这正则：`^(\d*|\d{1,3}(,\d{3})*)(\.\d{1,2})?`。居然是对的！完美的考虑了带逗号和不带逗号的场景。


下面这个表情就是我当时的表情。
![WTF](http://7vzqg8.com1.z0.glb.clouddn.com/using-pjax/pajax_before.png)
